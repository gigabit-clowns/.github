name: "SonarQube scan"
description: "Runs SonarQube scan."

inputs:
  sonar-token:
    description: "SonarQube token"
    required: true
  build-artifact-name:
    description: "Name of the build artifact to download."
    required: true
  coverage-pattern:
    description: "Pattern of the artifact/s to download."
    required: false
  coverage-path:
    description: "Path where the artifact/s will be downloaded."
    required: false
  show-coverage:
    description: "If set to true, merged report path is both uploaded and shown in the terminal."
    required: false
    default: false

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0 # Needed to get git blame information for SonarQube

    # Build artifact needed for manual scan
    - name: Download build artifact
      uses: actions/download-artifact@v6
      with:
        name: ${{ inputs.build-artifact-name }}
        path: ${{ github.workspace }}/build

    #### Coverage report section start ####
    - name: Download coverage artifacts
      uses: actions/download-artifact@v6
      if: ${{ inputs.coverage-pattern && inputs.coverage-path }}
      with:
        pattern: ${{ inputs.coverage-pattern }}
        path: ${{ inputs.coverage-path }}

    - name: Substitute placeholder with current workspace
      if: ${{ inputs.coverage-pattern && inputs.coverage-path }}
      working-directory: "${{ github.workspace }}/build"
      shell: bash
      run: |
        # Find all coverage.xml files and replace placeholder with actual workspace path
        find . -name "coverage.xml" -type f -print0 | while IFS= read -r -d '' file; do
          sed -i.bak "s|GITHUB_WORKSPACE|$GITHUB_WORKSPACE|g" "$file"
          rm -f "$file.bak"
        done

    - name: Setup .NET Core # Required to execute ReportGenerator
      if: ${{ inputs.coverage-pattern && inputs.coverage-path }}
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.x
        dotnet-quality: 'ga'

    - name: Merge coverage reports (ReportGenerator)
      if: ${{ inputs.coverage-pattern && inputs.coverage-path }}
      uses: danielpalme/ReportGenerator-GitHub-Action@v5
      with:
        reports: ${{ inputs.coverage-path }}/${{ inputs.coverage-pattern }}/coverage.xml
        targetdir: build
        reporttypes: Cobertura
        sourcedirs: ${{ github.workspace }}
    
    - name: Rename merged coverage report
      if: ${{ inputs.coverage-pattern && inputs.coverage-path }}
      shell: bash
      run: mv ./build/Cobertura.xml ./build/coverage.xml

    - name: Upload merged coverage report # For debugging purposes
      if: ${{ inputs.show-coverage == 'true' }}
      uses: actions/upload-artifact@v5
      with:
        name: merged-coverage-report
        path: build/coverage.xml
    
    - name: Show merged coverage report # For debugging purposes
      if: ${{ inputs.show-coverage == 'true' }}
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python -m pip install pycobertura
        pycobertura show --format=text build/coverage.xml
    #### Coverage report section end ####

    # Regular scan for most events
    - name: SonarQube scan for most events
      if: ${{ github.event_name != 'workflow_dispatch' }}
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        SONAR_TOKEN: ${{ inputs.sonar-token }}

    # When trigger event is workflow_dispatch, SonarQube action
    # will always treat it as main branch unless we specify the branch name
    - name: SonarQube scan for workflow_dispatch
      if: ${{ github.event_name == 'workflow_dispatch' }}
      uses: SonarSource/sonarqube-scan-action@v6
      env:
          SONAR_TOKEN: ${{ inputs.sonar-token }}
      with:
        args: >
          -Dsonar.branch.name=${{ github.ref_name }}
